name: Webwriter

on:
  push:
  pull_request:

jobs:
  ##### ===========================
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: SakamataFontProject/builder/build

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # ToDo: Use official butil-ttf action
      #
      #- name: Build
      #  uses: ./SakamataFontProject/.github/actions/build-ttf
      #  with:
      #    weight: 0
      #    strict: nostrict

      - name: Install depends
        run: ./_install_reqs_ubuntu.sh

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Run build
        run: dotnet run -- --rawdir ../../raw --weight 0 nostrict --filename sakamata-font-0-nostrict --fontname "Sakamata Chloe Font"

      - uses: actions/upload-artifact@v4
        with:
          name: sakamata-font-0-nostrict
          path: |
            SakamataFontProject/builder/build/sakamata-font-0-nostrict.ttf
            SakamataFontProject/builder/build/sakamata-font-0-nostrict.sources.tsv

  ##### ===========================
  build-jtc:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: SakamataTraditionalCalligraphyFont/builder/build

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # ToDo: Use official butil-ttf action
      #
      #- name: Build
      #  uses: ./SakamataFontProject/.github/actions/build-ttf
      #  with:
      #    weight: 0
      #    strict: nostrict

      - name: Install depends
        run: ./_install_reqs_ubuntu.sh

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Run build
        run: dotnet run -- --rawdir ../../raw --weight 0 nostrict --filename sakamata-jtc-font-0-nostrict --fontname "Sakamata Chloe Font"

      - uses: actions/upload-artifact@v4
        with:
          name: sakamata-jtc-font-0-nostrict
          path: |
            SakamataTraditionalCalligraphyFont/builder/build/sakamata-jtc-font-0-nostrict.ttf
            SakamataTraditionalCalligraphyFont/builder/build/sakamata-jtc-font-0-nostrict.sources.tsv

  ##### ===========================
  gen-chart:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Run chart-generator
        working-directory: SakamataFontProject/builder/chart-generator
        run: |
          dotnet run --rawdir ../../raw

      - uses: actions/upload-artifact@v4
        with:
          name: generated-charts
          path: SakamataFontProject/builder/chart-generator/output/*

  ##### ===========================
  gen-chart-jtc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Run chart-generator
        working-directory: SakamataTraditionalCalligraphyFont/builder/chart-generator
        run: |
          dotnet run --rawdir ../../raw

      - uses: actions/upload-artifact@v4
        with:
          name: generated-charts-jtc
          path: SakamataTraditionalCalligraphyFont/builder/chart-generator/output/*

  ##### ===========================
  build-webfont:
    runs-on: ubuntu-latest
    needs:
      - build
      - gen-chart
      - build-jtc
      - gen-chart-jtc

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: sakamata-font-0-nostrict
          path: fonts

      - uses: actions/download-artifact@v4
        with:
          name: sakamata-jtc-font-0-nostrict
          path: fonts

      - uses: actions/download-artifact@v4
        with:
          name: generated-charts
          path: ~/artifact/chart

      - uses: actions/download-artifact@v4
        with:
          name: generated-charts-jtc
          path: ~/artifact/chart-jtc

      - name: Install woff2
        run: sudo apt-get install -y woff2

      - name: Compress to woff2
        run: |
          woff2_compress fonts/sakamata-font-0-nostrict.ttf
          woff2_compress fonts/sakamata-jtc-font-0-nostrict.ttf

      - uses: actions/upload-artifact@v4
        with:
          name: webfont
          path: fonts/*.woff2

      - name: Copy data to gatsby builds
        run: |
          mkdir static/fonts
          cp fonts/*.woff2 static/fonts/
          cp fonts/*.sources.tsv static/fonts/
          cp ~/artifact/chart/char.tsv static/fonts/sakamata-font-char.tsv
          cp ~/artifact/chart-jtc/char.tsv static/fonts/sakamata-jtc-font-char.tsv

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
         
      - uses: pnpm/action-setup@v2
        with:
          version: latest
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: webwriter
          path: public
      

  ##### ===========================
  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs:
      - build-webfont

    permissions:
      contents: read
      deployments: write
      pages: write
      id-token: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: webwriter
          path: public

      - name: Getting branch name
        id: branch_name
        run: echo ::set-output name=short_ref::${GITHUB_REF#refs/*/}

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sakamatafontproject
          directory: public
          branch: ${{ steps.branch_name.outputs.short_ref }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
